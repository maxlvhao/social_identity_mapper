<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Researcher View - Social Identity Mapping</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Researcher-specific styles */
    .researcher-page {
      min-height: 100vh;
      padding: 30px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .researcher-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .researcher-header h1 {
      font-size: 1.75rem;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .researcher-header p {
      color: var(--text-light);
    }

    .upload-section {
      text-align: center;
      margin-bottom: 20px;
    }

    .upload-area {
      background: var(--card-bg);
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 40px;
      max-width: 500px;
      margin: 0 auto;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-area:hover, .upload-area.dragover {
      border-color: var(--primary);
      background: #f8f9ff;
    }

    .upload-area p {
      margin-bottom: 15px;
      color: var(--text-light);
    }

    .upload-area input[type="file"] {
      display: none;
    }

    .report-section {
      display: none;
    }

    .report-section.active {
      display: block;
    }

    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .session-info-bar {
      background: var(--card-bg);
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    .session-info-bar span {
      margin-right: 20px;
      font-size: 14px;
    }

    .session-info-bar strong {
      color: var(--primary);
    }

    .back-link {
      position: fixed;
      top: 15px;
      left: 15px;
      color: var(--text-light);
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      z-index: 100;
    }

    .back-link:hover {
      color: var(--primary);
    }

    /* Report Cards */
    .report-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    .report-card h3 {
      color: var(--primary);
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--primary);
      font-size: 1.1rem;
    }

    .report-card h3.community-header {
      color: var(--community-color);
      border-bottom-color: var(--community-color);
    }

    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .data-table th,
    .data-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .data-table th {
      background: var(--bg);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      color: var(--text-light);
    }

    .data-table tbody tr:hover {
      background: #f8f9fa;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-identity {
      background: var(--identity-color);
      color: white;
    }

    .badge-community {
      background: var(--community-color);
      color: white;
    }

    .badge-top {
      background: var(--success);
      color: white;
    }

    /* Strength Bars */
    .strength-bar {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .strength-bar-fill {
      height: 8px;
      background: var(--primary);
      border-radius: 4px;
    }

    .strength-bar-track {
      flex: 1;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      max-width: 100px;
    }

    /* Tags */
    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag {
      background: var(--bg);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      color: var(--text);
    }

    /* Map Preview - 4:3 ratio matching main app */
    .map-preview {
      width: 100%;
      max-width: 800px;
      height: 600px;
      margin: 0 auto;
      background: white;
      border: 2px solid var(--border);
      border-radius: 12px;
      position: relative;
      overflow: hidden;
      background:
        linear-gradient(var(--border) 1px, transparent 1px),
        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 40px 40px;
    }

    .map-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    /* X-Y axis crosshairs */
    .map-canvas::before,
    .map-canvas::after {
      content: '';
      position: absolute;
      background: #aaa;
    }

    .map-canvas::before {
      left: 50%;
      top: 0;
      bottom: 0;
      width: 2px;
      transform: translateX(-50%);
    }

    .map-canvas::after {
      top: 50%;
      left: 0;
      right: 0;
      height: 2px;
      transform: translateY(-50%);
    }

    .map-axis-label {
      position: absolute;
      font-size: 11px;
      color: var(--text-light);
      background: rgba(255,255,255,0.9);
      padding: 2px 6px;
      border-radius: 3px;
      z-index: 5;
    }

    /* Map markers - matching main app design exactly */
    .map-marker {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: default;
      user-select: none;
      z-index: 20;
    }

    .map-marker .marker-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text);
      background: rgba(255,255,255,0.95);
      padding: 3px 8px;
      border-radius: 4px;
      margin-bottom: 4px;
      white-space: nowrap;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .map-marker.identity-marker .marker-label {
      border: 2px solid var(--identity-color);
    }

    .map-marker.community-marker .marker-label {
      border: 2px solid var(--community-color);
    }

    .map-marker .marker-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--identity-color);
      box-shadow: 0 2px 6px rgba(63, 81, 181, 0.4);
    }

    .map-marker .marker-square {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      background: var(--community-color);
      box-shadow: 0 2px 6px rgba(249, 168, 37, 0.4);
    }

    /* Community Detail Sections - Redesigned */
    .community-section {
      margin-bottom: 25px;
      padding-bottom: 25px;
      border-bottom: 2px solid var(--border);
    }

    .community-section:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .community-section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }

    .community-section-header .rank-badge {
      background: var(--community-color);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
    }

    .community-section-header h4 {
      color: var(--text);
      margin: 0;
      font-size: 1.1rem;
    }

    /* Subsection styling */
    .detail-subsections {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      .detail-subsections {
        grid-template-columns: 1fr;
      }
    }

    .detail-subsection {
      background: var(--bg);
      border-radius: 8px;
      padding: 14px;
    }

    .subsection-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-light);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    /* Compact metric display */
    .metric-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .metric-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .metric-score {
      background: var(--primary);
      color: white;
      min-width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 13px;
      flex-shrink: 0;
    }

    .metric-score.na {
      background: var(--border);
      color: var(--text-light);
    }

    .metric-desc {
      font-size: 12px;
      color: var(--text);
      line-height: 1.3;
    }

    /* Tag list for boundary markers / methods */
    .tags-row {
      margin-top: 10px;
    }

    .tags-label {
      font-size: 11px;
      color: var(--text-light);
      margin-bottom: 6px;
    }

    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    .tag {
      background: white;
      border: 1px solid var(--border);
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      color: var(--text);
    }

    /* Text response */
    .text-response-section {
      margin-top: 12px;
    }

    .text-response-label {
      font-size: 11px;
      color: var(--text-light);
      margin-bottom: 6px;
    }

    .text-response {
      background: white;
      border: 1px solid var(--border);
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 12px;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    /* Empty state */
    .empty-metric {
      color: var(--text-light);
      font-size: 12px;
      font-style: italic;
    }

    /* Legend */
    .legend {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .legend-box {
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }

    .legend-box.identity {
      background: var(--identity-color);
    }

    .legend-box.community {
      background: var(--community-color);
    }
  </style>
</head>
<body>
  <div class="researcher-page">
    <a href="/" class="back-link">&larr; Back to Activity</a>

    <div class="researcher-header">
      <h1>Researcher View</h1>
      <p>Upload a participant's JSON data file to view their complete response report.</p>
    </div>

    <div class="upload-section" id="upload-section">
      <div class="upload-area" id="upload-area">
        <p>Drag and drop a JSON file here, or click to select</p>
        <button class="btn btn-primary">Choose File</button>
        <input type="file" id="file-input" accept=".json">
      </div>
    </div>

    <div class="report-section" id="report-section">
      <div class="report-header">
        <div class="session-info-bar">
          <span>Session: <strong id="report-session">--</strong></span>
          <span>Created: <strong id="report-date">--</strong></span>
        </div>
        <button class="btn btn-secondary" id="load-another">Load Another File</button>
      </div>

      <!-- Identities Section -->
      <div class="report-card">
        <h3>Identities</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Identity</th>
              <th>Type</th>
              <th>Top 3</th>
              <th>Centrality</th>
              <th>Solidarity</th>
              <th>Satisfaction</th>
              <th>Stability</th>
            </tr>
          </thead>
          <tbody id="identities-table"></tbody>
        </table>
      </div>

      <!-- Communities Section -->
      <div class="report-card">
        <h3 class="community-header">Communities</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Community</th>
              <th>Setting</th>
              <th>Top 3</th>
            </tr>
          </thead>
          <tbody id="communities-table"></tbody>
        </table>
      </div>

      <!-- Community Details (for top 3) -->
      <div class="report-card">
        <h3 class="community-header">Community Details (Top 3)</h3>
        <div id="community-details"></div>
      </div>

      <!-- Map Section -->
      <div class="report-card">
        <h3>Information Behavior Map</h3>
        <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">
          X-axis: Type of information (Specialized ↔ General) | Y-axis: Frequency of information seeking
        </p>
        <div class="map-preview" id="map-preview">
          <div class="map-axis-label" style="left: 10px; top: 50%; transform: translateY(-50%);">Specialized</div>
          <div class="map-axis-label" style="right: 10px; top: 50%; transform: translateY(-50%);">General</div>
          <div class="map-axis-label" style="top: 10px; left: 50%; transform: translateX(-50%);">High frequency</div>
          <div class="map-axis-label" style="bottom: 10px; left: 50%; transform: translateX(-50%);">Low frequency</div>
          <div class="map-canvas" id="map-canvas"></div>
        </div>
        <div class="legend">
          <div class="legend-item"><span class="legend-box identity"></span> Identity</div>
          <div class="legend-item"><span class="legend-box community"></span> Community</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      'use strict';

      const $ = id => document.getElementById(id);
      let loadedData = null;

      // Constants for display
      const TYPE_LABELS = {
        'role-group': 'Role-based / Group-based',
        'personal-trait': 'Personal trait',
        'belief-value': 'Belief or value',
        'place-based': 'Place-based',
        'other': 'Other'
      };

      const SETTING_LABELS = {
        'online': 'Online',
        'offline': 'Offline',
        'hybrid': 'Hybrid'
      };

      const BOUNDARY_LABELS = {
        'jargon': 'Jargon / lingo',
        'credentials': 'Credentials / insider knowledge',
        'sources': 'News sources / information sources',
        'rituals': 'Rituals / events',
        'humor': 'Humor / memes',
        'moral': 'Moral stances',
        'time': 'Time commitment',
        'technical': 'Technical skill',
        'location': 'Physical location'
      };

      const KEEPUP_LABELS = {
        'lurk': 'Lurk / read',
        'ask': 'Ask someone',
        'follow-accounts': 'Follow key accounts',
        'newsletters': 'Newsletters',
        'discord': 'Group chat / Discord',
        'official': 'Official channels',
        'campus': 'Campus media',
        'mainstream': 'Mainstream media',
        'podcasts': 'Podcasts / YouTube',
        'other': 'Other'
      };

      const LIKERT_LABELS = {
        1: 'Strongly Disagree',
        2: 'Disagree',
        3: 'Moderately Disagree',
        4: 'Neutral',
        5: 'Moderately Agree',
        6: 'Agree',
        7: 'Strongly Agree'
      };

      // File upload handling
      const uploadArea = $('upload-area');
      const fileInput = $('file-input');

      uploadArea.addEventListener('click', () => fileInput.click());

      uploadArea.addEventListener('dragover', e => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) loadFile(file);
      });

      fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) loadFile(file);
      });

      $('load-another').addEventListener('click', () => {
        $('upload-section').style.display = 'block';
        $('report-section').classList.remove('active');
        fileInput.value = '';
      });

      function loadFile(file) {
        const reader = new FileReader();
        reader.onload = e => {
          try {
            loadedData = JSON.parse(e.target.result);
            renderReport();
          } catch (err) {
            alert('Invalid JSON file');
          }
        };
        reader.readAsText(file);
      }

      function renderReport() {
        if (!loadedData) return;

        $('upload-section').style.display = 'none';
        $('report-section').classList.add('active');

        // Header info
        $('report-session').textContent = loadedData.sessionId || 'Unknown';
        $('report-date').textContent = loadedData.createdAt ? new Date(loadedData.createdAt).toLocaleDateString() : '--';

        // Identities table
        renderIdentitiesTable();

        // Communities table
        renderCommunitiesTable();

        // Community details
        renderCommunityDetails();

        // Map
        renderMap();
      }

      function renderIdentitiesTable() {
        const tbody = $('identities-table');
        const identities = loadedData.identities || [];
        const strength = loadedData.identityStrength || {};

        tbody.innerHTML = identities.map(i => {
          const s = strength[i.id] || {};
          const isTop = i.isTopThree;

          return `
            <tr>
              <td><strong>${escapeHtml(i.name)}</strong></td>
              <td>${TYPE_LABELS[i.type] || i.type || '--'}</td>
              <td>${isTop ? `<span class="badge badge-top">#${i.topRank}</span>` : '--'}</td>
              <td>${isTop ? renderStrengthBar(s.centrality) : '--'}</td>
              <td>${isTop ? renderStrengthBar(s.solidarity) : '--'}</td>
              <td>${isTop ? renderStrengthBar(s.satisfaction) : '--'}</td>
              <td>${isTop ? renderStrengthBar(s.stability) : '--'}</td>
            </tr>
          `;
        }).join('');
      }

      function renderStrengthBar(value) {
        if (value === undefined || value === null) return '--';
        const width = (value / 7) * 100;
        return `
          <div class="strength-bar">
            <div class="strength-bar-track">
              <div class="strength-bar-fill" style="width: ${width}%"></div>
            </div>
            <span>${value}/7</span>
          </div>
        `;
      }

      function renderCommunitiesTable() {
        const tbody = $('communities-table');
        const communities = loadedData.communities || [];

        tbody.innerHTML = communities.map(c => {
          const isTop = c.isTopThree;
          return `
            <tr>
              <td><strong>${escapeHtml(c.name)}</strong></td>
              <td>${SETTING_LABELS[c.setting] || c.setting || '--'}</td>
              <td>${isTop ? `<span class="badge badge-top">#${c.topRank}</span>` : '--'}</td>
            </tr>
          `;
        }).join('');
      }

      function renderCommunityDetails() {
        const container = $('community-details');
        const communities = (loadedData.communities || []).filter(c => c.isTopThree).sort((a, b) => a.topRank - b.topRank);
        const belonging = loadedData.belongingUncertainty || {};
        const participation = loadedData.communityParticipation || {};
        const norms = loadedData.informationNorms || {};

        if (communities.length === 0) {
          container.innerHTML = '<p class="empty-metric">No top communities selected.</p>';
          return;
        }

        container.innerHTML = communities.map(c => {
          const b = belonging[c.id] || {};
          const p = participation[c.id] || {};
          const n = norms[c.id] || {};

          return `
            <div class="community-section">
              <div class="community-section-header">
                <span class="rank-badge">${c.topRank}</span>
                <h4>${escapeHtml(c.name)}</h4>
              </div>

              <div class="detail-subsections">
                <!-- Belonging Uncertainty -->
                <div class="detail-subsection">
                  <div class="subsection-title">Belonging</div>
                  <div class="metric-grid">
                    ${renderMetricItem(b.belongSometimes, 'Sometimes belong, sometimes don\'t')}
                    ${renderMetricItem(b.belongBad, 'Bad times → don\'t belong')}
                    ${renderMetricItem(b.belongGood, 'Good times → really belong')}
                  </div>
                </div>

                <!-- Participation -->
                <div class="detail-subsection">
                  <div class="subsection-title">Participation</div>
                  <div class="metric-grid">
                    ${renderMetricItem(p.difficulty, 'Newcomer difficulty')}
                  </div>
                  ${p.boundaryMarkers && p.boundaryMarkers.length > 0 ? `
                    <div class="tags-row">
                      <div class="tags-label">Boundary markers:</div>
                      <div class="tag-list">
                        ${p.boundaryMarkers.map(m => `<span class="tag">${BOUNDARY_LABELS[m] || m}</span>`).join('')}
                      </div>
                    </div>
                  ` : ''}
                </div>

                <!-- Information Norms -->
                <div class="detail-subsection">
                  <div class="subsection-title">Info Norms</div>
                  <div class="metric-grid">
                    ${renderMetricItem(n.languageNeeded, 'Need community language')}
                    ${renderMetricItem(n.effortLearning, 'Effort to learn language')}
                    ${renderMetricItem(n.sourcesExpected, 'Expected sources')}
                    ${renderMetricItem(n.wrongSourcesJudged, 'Wrong sources judged')}
                  </div>
                  ${n.keepUpMethods && n.keepUpMethods.length > 0 ? `
                    <div class="tags-row">
                      <div class="tags-label">Keep-up methods:</div>
                      <div class="tag-list">
                        ${n.keepUpMethods.map(m => `<span class="tag">${KEEPUP_LABELS[m] || m}</span>`).join('')}
                      </div>
                    </div>
                  ` : ''}
                  ${n.fluencySources ? `
                    <div class="text-response-section">
                      <div class="text-response-label">Fluency sources:</div>
                      <div class="text-response">${escapeHtml(n.fluencySources)}</div>
                    </div>
                  ` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      function renderMetricItem(value, label) {
        if (value === undefined || value === null) {
          return `
            <div class="metric-item">
              <span class="metric-score na">-</span>
              <span class="metric-desc">${label}</span>
            </div>
          `;
        }
        return `
          <div class="metric-item">
            <span class="metric-score">${value}</span>
            <span class="metric-desc">${label}</span>
          </div>
        `;
      }

      function renderMap() {
        const canvas = $('map-canvas');
        const container = $('map-preview');
        canvas.innerHTML = '';

        const topIdentities = (loadedData.identities || []).filter(i => i.isTopThree);
        const topCommunities = (loadedData.communities || []).filter(c => c.isTopThree);
        const positions = loadedData.mapPositions || {};

        // Get container dimensions for converting percentages to pixels
        const containerRect = container.getBoundingClientRect();

        // Helper to convert old pixel positions to percentages if needed
        function normalizePosition(pos) {
          if (!pos) return null;
          // If values are > 1, they're old pixel values - convert to percentages
          if (pos.x > 1 || pos.y > 1) {
            return {
              x: Math.min(1, Math.max(0, pos.x / 800)),
              y: Math.min(1, Math.max(0, pos.y / 600))
            };
          }
          return pos;
        }

        // Render identity markers (round dot)
        topIdentities.forEach(identity => {
          const pos = normalizePosition(positions[identity.id]);
          if (!pos) return;

          const marker = document.createElement('div');
          marker.className = 'map-marker identity-marker';
          marker.style.left = (pos.x * containerRect.width) + 'px';
          marker.style.top = (pos.y * containerRect.height) + 'px';
          marker.innerHTML = `
            <span class="marker-label">${escapeHtml(identity.name)}</span>
            <span class="marker-dot"></span>
          `;
          canvas.appendChild(marker);
        });

        // Render community markers (square)
        topCommunities.forEach(community => {
          const pos = normalizePosition(positions[community.id]);
          if (!pos) return;

          const marker = document.createElement('div');
          marker.className = 'map-marker community-marker';
          marker.style.left = (pos.x * containerRect.width) + 'px';
          marker.style.top = (pos.y * containerRect.height) + 'px';
          marker.innerHTML = `
            <span class="marker-label">${escapeHtml(community.name)}</span>
            <span class="marker-square"></span>
          `;
          canvas.appendChild(marker);
        });
      }

      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

    })();
  </script>
</body>
</html>
