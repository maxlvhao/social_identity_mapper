<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Researcher View - Social Identity Mapping</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Researcher-specific styles */
    .researcher-page {
      min-height: 100vh;
      padding: 30px;
      display: flex;
      flex-direction: column;
    }

    .researcher-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .researcher-header h1 {
      font-size: 1.75rem;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .researcher-header p {
      color: var(--text-light);
    }

    .upload-section {
      text-align: center;
      margin-bottom: 20px;
    }

    .upload-area {
      background: var(--card-bg);
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 40px;
      max-width: 500px;
      margin: 0 auto;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-area:hover, .upload-area.dragover {
      border-color: var(--primary);
      background: #f8f9ff;
    }

    .upload-area p {
      margin-bottom: 15px;
      color: var(--text-light);
    }

    .upload-area input[type="file"] {
      display: none;
    }

    .visualization-section {
      display: none;
      flex: 1;
      flex-direction: column;
    }

    .visualization-section.active {
      display: flex;
    }

    .viz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .session-info-bar {
      background: var(--card-bg);
      padding: 10px 20px;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    .session-info-bar span {
      margin-right: 20px;
      font-size: 14px;
    }

    .session-info-bar strong {
      color: var(--primary);
    }

    .viz-canvas-container {
      flex: 1;
      min-height: 400px;
      background: white;
      border: 2px solid var(--border);
      border-radius: 12px;
      position: relative;
      overflow: hidden;
      background-image:
        linear-gradient(var(--border) 1px, transparent 1px),
        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 40px 40px;
    }

    .viz-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .viz-svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    /* Tooltip styles */
    .group-card[data-tooltip] {
      position: relative;
    }

    .corner-tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .corner-tooltip.visible {
      opacity: 1;
    }

    .back-link {
      position: fixed;
      top: 15px;
      left: 15px;
      color: var(--text-light);
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .back-link:hover {
      color: var(--primary);
    }

    .legend {
      background: var(--card-bg);
      padding: 15px 20px;
      border-radius: 8px;
      margin-top: 15px;
      box-shadow: var(--shadow);
    }

    .legend h4 {
      margin-bottom: 10px;
      font-size: 14px;
      color: var(--text);
    }

    .legend-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 8px;
      font-size: 13px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-item .corner-label {
      background: var(--bg);
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 11px;
    }

    .size-legend {
      display: flex;
      gap: 15px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .size-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }

    .size-box {
      border-radius: 4px;
    }

    .size-box.high {
      width: 24px;
      height: 24px;
      background: var(--importance-high);
    }

    .size-box.medium {
      width: 20px;
      height: 20px;
      background: var(--importance-medium);
    }

    .size-box.low {
      width: 16px;
      height: 16px;
      background: var(--importance-low);
    }

    .connection-legend {
      display: flex;
      gap: 20px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .conn-legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .conn-legend-item svg {
      flex-shrink: 0;
    }
  </style>
</head>
<body>
  <div class="researcher-page">
    <a href="/" class="back-link">&larr; Back to Activity</a>

    <div class="researcher-header">
      <h1>Researcher View</h1>
      <p>Upload a participant's JSON data file to visualize their social identity map.</p>
    </div>

    <div class="upload-section" id="upload-section">
      <div class="upload-area" id="upload-area">
        <p>Drag and drop a JSON file here, or click to select</p>
        <button class="btn btn-primary">Choose File</button>
        <input type="file" id="file-input" accept=".json">
      </div>
    </div>

    <div class="visualization-section" id="visualization-section">
      <div class="viz-header">
        <div class="session-info-bar">
          <span>Session: <strong id="viz-session">--</strong></span>
          <span>Groups: <strong id="viz-groups">0</strong></span>
          <span>Connections: <strong id="viz-connections">0</strong></span>
        </div>
        <button class="btn btn-secondary" id="load-another">Load Another File</button>
      </div>

      <div class="viz-canvas-container" id="viz-container">
        <svg class="viz-svg" id="viz-svg"></svg>
        <div class="viz-canvas" id="viz-canvas"></div>
      </div>

      <div class="legend">
        <h4>Card Corner Values</h4>
        <div class="legend-grid">
          <div class="legend-item"><span class="corner-label">TL</span> Positivity (1-10)</div>
          <div class="legend-item"><span class="corner-label">TR</span> Contact (days/month)</div>
          <div class="legend-item"><span class="corner-label">BL</span> Tenure (years)</div>
          <div class="legend-item"><span class="corner-label">BR</span> Representativeness (1-10)</div>
        </div>
        <div class="size-legend">
          <div class="size-legend-item"><span class="size-box high"></span> Very Important</div>
          <div class="size-legend-item"><span class="size-box medium"></span> Moderate</div>
          <div class="size-legend-item"><span class="size-box low"></span> Less Important</div>
        </div>
        <div class="connection-legend">
          <div class="conn-legend-item">
            <svg width="40" height="12"><line x1="0" y1="6" x2="40" y2="6" stroke="#495057" stroke-width="3"/></svg>
            <span>Very Easy</span>
          </div>
          <div class="conn-legend-item">
            <svg width="40" height="12"><path d="M0,6 Q10,0 20,6 Q30,12 40,6" stroke="#495057" stroke-width="3" fill="none"/></svg>
            <span>Moderate</span>
          </div>
          <div class="conn-legend-item">
            <svg width="40" height="12"><path d="M0,6 L8,1 L16,11 L24,1 L32,11 L40,6" stroke="#495057" stroke-width="3" fill="none"/></svg>
            <span>Not Easy</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="corner-tooltip" id="corner-tooltip"></div>

  <script>
    (function() {
      'use strict';

      const $ = id => document.getElementById(id);
      let loadedData = null;

      // File upload handling
      const uploadArea = $('upload-area');
      const fileInput = $('file-input');

      uploadArea.addEventListener('click', () => fileInput.click());

      uploadArea.addEventListener('dragover', e => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) loadFile(file);
      });

      fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) loadFile(file);
      });

      $('load-another').addEventListener('click', () => {
        $('upload-section').style.display = 'block';
        $('visualization-section').classList.remove('active');
        fileInput.value = '';
      });

      function loadFile(file) {
        const reader = new FileReader();
        reader.onload = e => {
          try {
            loadedData = JSON.parse(e.target.result);
            renderVisualization();
          } catch (err) {
            alert('Invalid JSON file');
          }
        };
        reader.readAsText(file);
      }

      function renderVisualization() {
        if (!loadedData) return;

        $('upload-section').style.display = 'none';
        $('visualization-section').classList.add('active');

        $('viz-session').textContent = loadedData.sessionId || 'Unknown';
        $('viz-groups').textContent = loadedData.groups?.length || 0;
        $('viz-connections').textContent = loadedData.connections?.length || 0;

        const container = $('viz-container');
        const canvas = $('viz-canvas');
        const svg = $('viz-svg');

        canvas.innerHTML = '';
        svg.innerHTML = '';

        if (!loadedData.groups || loadedData.groups.length === 0) {
          canvas.innerHTML = '<p style="text-align:center;padding:40px;color:#6c757d;">No groups in this data file.</p>';
          return;
        }

        // Calculate bounds
        let minX = loadedData.meX - 30, minY = loadedData.meY - 30;
        let maxX = loadedData.meX + 30, maxY = loadedData.meY + 30;

        loadedData.groups.forEach(g => {
          const size = g.importance === 'high' ? 130 : g.importance === 'low' ? 75 : 100;
          if (g.x < minX) minX = g.x;
          if (g.y < minY) minY = g.y;
          if (g.x + size > maxX) maxX = g.x + size;
          if (g.y + size > maxY) maxY = g.y + size;
        });

        const padding = 40;
        const contentWidth = maxX - minX + padding * 2;
        const contentHeight = maxY - minY + padding * 2;
        const containerWidth = container.clientWidth;
        const containerHeight = container.clientHeight;

        const scaleX = containerWidth / contentWidth;
        const scaleY = containerHeight / contentHeight;
        const scale = Math.min(scaleX, scaleY, 1.5);

        const offsetX = (containerWidth - contentWidth * scale) / 2;
        const offsetY = (containerHeight - contentHeight * scale) / 2;

        canvas.style.transform = `scale(${scale})`;
        canvas.style.transformOrigin = 'top left';
        canvas.style.left = offsetX + 'px';
        canvas.style.top = offsetY + 'px';
        canvas.style.width = contentWidth + 'px';
        canvas.style.height = contentHeight + 'px';

        svg.style.transform = `scale(${scale})`;
        svg.style.transformOrigin = 'top left';
        svg.style.left = offsetX + 'px';
        svg.style.top = offsetY + 'px';
        svg.style.width = contentWidth + 'px';
        svg.style.height = contentHeight + 'px';

        // Adjusted positions
        const adjMeX = loadedData.meX - minX + padding;
        const adjMeY = loadedData.meY - minY + padding;

        // Render Me block
        const meBlock = document.createElement('div');
        meBlock.className = 'me-block locked';
        meBlock.textContent = 'Me';
        meBlock.style.left = (adjMeX - 30) + 'px';
        meBlock.style.top = (adjMeY - 30) + 'px';
        canvas.appendChild(meBlock);

        // Render groups
        const groupPositions = {};
        loadedData.groups.forEach(g => {
          const adjX = g.x - minX + padding;
          const adjY = g.y - minY + padding;
          groupPositions[g.id] = { x: adjX, y: adjY, g };

          const card = document.createElement('div');
          card.className = `group-card size-${g.importance || 'medium'}`;
          card.dataset.id = g.id;
          card.style.left = adjX + 'px';
          card.style.top = adjY + 'px';

          const displayVal = v => v !== null && v !== undefined ? v : '?';

          card.innerHTML = `
            <span class="card-corner tl" data-metric="positivity" data-value="${displayVal(g.positivity)}">${displayVal(g.positivity)}</span>
            <span class="card-corner tr" data-metric="contact" data-value="${displayVal(g.contact)}">${displayVal(g.contact)}</span>
            <span class="card-name">${escapeHtml(g.name)}</span>
            <span class="card-corner bl" data-metric="tenure" data-value="${displayVal(g.tenure)}">${displayVal(g.tenure)}</span>
            <span class="card-corner br" data-metric="representativeness" data-value="${displayVal(g.representativeness)}">${displayVal(g.representativeness)}</span>
          `;

          canvas.appendChild(card);
        });

        // Render connections
        requestAnimationFrame(() => {
          (loadedData.connections || []).forEach(conn => {
            let x1, y1, x2, y2;

            if (conn.from === 'me') {
              x1 = adjMeX;
              y1 = adjMeY;
            } else {
              const fromPos = groupPositions[conn.from];
              const fromCard = canvas.querySelector(`[data-id="${conn.from}"]`);
              if (!fromPos || !fromCard) return;
              x1 = fromPos.x + fromCard.offsetWidth / 2;
              y1 = fromPos.y + fromCard.offsetHeight / 2;
            }

            if (conn.to === 'me') {
              x2 = adjMeX;
              y2 = adjMeY;
            } else {
              const toPos = groupPositions[conn.to];
              const toCard = canvas.querySelector(`[data-id="${conn.to}"]`);
              if (!toPos || !toCard) return;
              x2 = toPos.x + toCard.offsetWidth / 2;
              y2 = toPos.y + toCard.offsetHeight / 2;
            }

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('class', `connection-line conn-${conn.type}`);
            path.setAttribute('d', getConnectionPath(x1, y1, x2, y2, conn.type));
            path.setAttribute('fill', 'none');
            svg.appendChild(path);
          });
        });
      }

      function getConnectionPath(x1, y1, x2, y2, type) {
        if (type === 'easy') {
          return `M ${x1} ${y1} L ${x2} ${y2}`;
        } else if (type === 'moderate') {
          const dx = x2 - x1;
          const dy = y2 - y1;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const amp = 15;
          const waves = Math.max(2, Math.floor(dist / 50));

          let d = `M ${x1} ${y1}`;
          for (let i = 1; i <= waves * 2; i++) {
            const t = i / (waves * 2);
            const px = x1 + dx * t;
            const py = y1 + dy * t;
            const offset = amp * (i % 2 === 0 ? 1 : -1);
            const perpX = -dy / dist * offset;
            const perpY = dx / dist * offset;

            if (i === waves * 2) {
              d += ` L ${x2} ${y2}`;
            } else {
              d += ` Q ${px + perpX} ${py + perpY} ${x1 + dx * (t + 0.5 / (waves * 2))} ${y1 + dy * (t + 0.5 / (waves * 2))}`;
            }
          }
          return d;
        } else {
          const dx = x2 - x1;
          const dy = y2 - y1;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const amp = 12;
          const segments = Math.max(3, Math.floor(dist / 30));

          let d = `M ${x1} ${y1}`;
          for (let i = 1; i <= segments; i++) {
            const t = i / segments;
            const px = x1 + dx * t;
            const py = y1 + dy * t;

            if (i < segments) {
              const offset = amp * (i % 2 === 0 ? 1 : -1);
              const perpX = -dy / dist * offset;
              const perpY = dx / dist * offset;
              d += ` L ${px + perpX} ${py + perpY}`;
            } else {
              d += ` L ${x2} ${y2}`;
            }
          }
          return d;
        }
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Tooltip handling
      const tooltip = $('corner-tooltip');
      const metricLabels = {
        positivity: 'Positivity',
        contact: 'Contact (days/month)',
        tenure: 'Tenure (years)',
        representativeness: 'Representativeness'
      };

      const metricDescriptions = {
        positivity: 'How positive they feel about being a member (1-10)',
        contact: 'Days per month engaged with this group',
        tenure: 'Years as a member of this group',
        representativeness: 'How well they represent this group (1-10)'
      };

      document.addEventListener('mouseover', e => {
        const corner = e.target.closest('.card-corner');
        if (corner) {
          const metric = corner.dataset.metric;
          const value = corner.dataset.value;
          tooltip.innerHTML = `<strong>${metricLabels[metric]}:</strong> ${value}<br><em>${metricDescriptions[metric]}</em>`;
          tooltip.classList.add('visible');
        }
      });

      document.addEventListener('mousemove', e => {
        if (tooltip.classList.contains('visible')) {
          tooltip.style.left = (e.clientX + 15) + 'px';
          tooltip.style.top = (e.clientY + 15) + 'px';
        }
      });

      document.addEventListener('mouseout', e => {
        if (e.target.closest('.card-corner')) {
          tooltip.classList.remove('visible');
        }
      });

    })();
  </script>
</body>
</html>
