<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Researcher View - Social Identity Mapping</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Researcher-specific styles */
    .researcher-page {
      min-height: 100vh;
      padding: 30px;
      max-width: 1000px;
      margin: 0 auto;
    }

    .researcher-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .researcher-header h1 {
      font-size: 1.75rem;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .researcher-header p {
      color: var(--text-light);
    }

    .upload-section {
      text-align: center;
      margin-bottom: 20px;
    }

    .upload-area {
      background: var(--card-bg);
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 40px;
      max-width: 500px;
      margin: 0 auto;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-area:hover, .upload-area.dragover {
      border-color: var(--primary);
      background: #f8f9ff;
    }

    .upload-area p {
      margin-bottom: 15px;
      color: var(--text-light);
    }

    .upload-area input[type="file"] {
      display: none;
    }

    .report-section {
      display: none;
    }

    .report-section.active {
      display: block;
    }

    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .session-info-bar {
      background: var(--card-bg);
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    .session-info-bar span {
      margin-right: 20px;
      font-size: 14px;
    }

    .session-info-bar strong {
      color: var(--primary);
    }

    .back-link {
      position: fixed;
      top: 15px;
      left: 15px;
      color: var(--text-light);
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      z-index: 100;
    }

    .back-link:hover {
      color: var(--primary);
    }

    /* Report Cards */
    .report-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    .report-card h3 {
      color: var(--primary);
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--primary);
      font-size: 1.1rem;
    }

    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .data-table th,
    .data-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .data-table th {
      background: var(--bg);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      color: var(--text-light);
    }

    .data-table tbody tr:hover {
      background: #f8f9fa;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-high {
      background: var(--importance-high);
      color: white;
    }

    .badge-medium {
      background: var(--importance-medium);
      color: white;
    }

    .badge-low {
      background: var(--importance-low);
      color: white;
    }

    /* Map Preview - square like main app */
    .map-preview {
      width: 100%;
      max-width: 600px;
      aspect-ratio: 1 / 1;
      margin: 0 auto;
      background: white;
      border: 2px solid var(--border);
      border-radius: 12px;
      position: relative;
      overflow: hidden;
      background-image:
        linear-gradient(var(--border) 1px, transparent 1px),
        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 40px 40px;
    }

    .map-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    /* SVG connections layer */
    .map-connections {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    /* Group cards on map */
    .map-group-card {
      position: absolute;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      user-select: none;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.15);
      transform: translate(-50%, -50%);
    }

    .map-group-card.size-high {
      width: 90px;
      height: 90px;
      background: var(--importance-high);
    }

    .map-group-card.size-medium {
      width: 70px;
      height: 70px;
      background: var(--importance-medium);
    }

    .map-group-card.size-low {
      width: 55px;
      height: 55px;
      background: var(--importance-low);
    }

    .map-group-card .card-name {
      color: white;
      font-weight: 600;
      text-align: center;
      padding: 4px;
      font-size: 10px;
      word-break: break-word;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
      line-height: 1.2;
    }

    .map-group-card.size-low .card-name {
      font-size: 9px;
    }

    /* Connection lines */
    .conn-easy {
      stroke: var(--conn-color);
      stroke-width: 3;
      fill: none;
    }

    .conn-moderate {
      stroke: var(--conn-color);
      stroke-width: 3;
      fill: none;
    }

    .conn-difficult {
      stroke: var(--conn-color);
      stroke-width: 3;
      fill: none;
    }

    /* Connections table */
    .conn-type {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .conn-type svg {
      flex-shrink: 0;
    }

    /* Legend */
    .legend {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border);
      justify-content: center;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .legend-box {
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }

    .legend-box.high { background: var(--importance-high); }
    .legend-box.medium { background: var(--importance-medium); }
    .legend-box.low { background: var(--importance-low); }

    /* Empty state */
    .empty-state {
      text-align: center;
      color: var(--text-light);
      padding: 20px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="researcher-page">
    <a href="/" class="back-link">&larr; Back to Activity</a>

    <div class="researcher-header">
      <h1>Researcher View</h1>
      <p>Upload a participant's JSON data file to view their complete response report.</p>
    </div>

    <div class="upload-section" id="upload-section">
      <div class="upload-area" id="upload-area">
        <p>Drag and drop a JSON file here, or click to select</p>
        <button class="btn btn-primary">Choose File</button>
        <input type="file" id="file-input" accept=".json">
      </div>
    </div>

    <div class="report-section" id="report-section">
      <div class="report-header">
        <div class="session-info-bar">
          <span>Session: <strong id="report-session">--</strong></span>
          <span>Created: <strong id="report-date">--</strong></span>
        </div>
        <button class="btn btn-secondary" id="load-another">Load Another File</button>
      </div>

      <!-- Communities Section -->
      <div class="report-card">
        <h3>Communities</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Community</th>
              <th>Importance</th>
              <th>Positivity</th>
              <th>Contact (days)</th>
              <th>Tenure (years)</th>
              <th>Representativeness</th>
            </tr>
          </thead>
          <tbody id="communities-table"></tbody>
        </table>
      </div>

      <!-- Position Map Section -->
      <div class="report-card">
        <h3>Position Map</h3>
        <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">
          Communities positioned by information overlap. Closer groups share more similar information.
        </p>
        <div class="map-preview" id="map-preview">
          <svg class="map-connections" id="map-connections"></svg>
          <div class="map-canvas" id="map-canvas"></div>
        </div>
        <div class="legend">
          <div class="legend-item"><span class="legend-box high"></span> Very Important</div>
          <div class="legend-item"><span class="legend-box medium"></span> Moderate</div>
          <div class="legend-item"><span class="legend-box low"></span> Less Important</div>
        </div>
      </div>

      <!-- Connections Section -->
      <div class="report-card">
        <h3>Connections</h3>
        <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">
          How easy it would be to discuss the same news topic across groups.
        </p>
        <table class="data-table" id="connections-table-container">
          <thead>
            <tr>
              <th>From</th>
              <th>To</th>
              <th>Conversation Flow</th>
            </tr>
          </thead>
          <tbody id="connections-table"></tbody>
        </table>
        <div class="empty-state hidden" id="no-connections">No connections drawn.</div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      'use strict';

      const $ = id => document.getElementById(id);
      let loadedData = null;

      const IMPORTANCE_LABELS = {
        'high': 'Very Important',
        'medium': 'Moderate',
        'low': 'Less Important'
      };

      const CONNECTION_LABELS = {
        'easy': 'Easy',
        'moderate': 'Moderate',
        'difficult': 'Difficult'
      };

      // File upload handling
      const uploadArea = $('upload-area');
      const fileInput = $('file-input');

      uploadArea.addEventListener('click', () => fileInput.click());

      uploadArea.addEventListener('dragover', e => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) loadFile(file);
      });

      fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) loadFile(file);
      });

      $('load-another').addEventListener('click', () => {
        $('upload-section').style.display = 'block';
        $('report-section').classList.remove('active');
        fileInput.value = '';
      });

      function loadFile(file) {
        const reader = new FileReader();
        reader.onload = e => {
          try {
            loadedData = JSON.parse(e.target.result);
            renderReport();
          } catch (err) {
            alert('Invalid JSON file');
          }
        };
        reader.readAsText(file);
      }

      function renderReport() {
        if (!loadedData) return;

        $('upload-section').style.display = 'none';
        $('report-section').classList.add('active');

        // Header info
        $('report-session').textContent = loadedData.sessionId || 'Unknown';
        $('report-date').textContent = loadedData.createdAt ? new Date(loadedData.createdAt).toLocaleDateString() : '--';

        // Communities table
        renderCommunitiesTable();

        // Position map with connections
        renderMap();

        // Connections table
        renderConnectionsTable();
      }

      function renderCommunitiesTable() {
        const tbody = $('communities-table');
        const communities = loadedData.communities || [];

        if (communities.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No communities added.</td></tr>';
          return;
        }

        tbody.innerHTML = communities.map(c => {
          const importanceClass = c.importance || 'medium';
          return `
            <tr>
              <td><strong>${escapeHtml(c.name)}</strong></td>
              <td><span class="badge badge-${importanceClass}">${IMPORTANCE_LABELS[c.importance] || '--'}</span></td>
              <td>${c.positivity !== undefined ? c.positivity + '/10' : '--'}</td>
              <td>${c.contact !== undefined ? c.contact : '--'}</td>
              <td>${c.tenure !== undefined ? c.tenure : '--'}</td>
              <td>${c.representativeness !== undefined ? c.representativeness + '/10' : '--'}</td>
            </tr>
          `;
        }).join('');
      }

      function renderMap() {
        const canvas = $('map-canvas');
        const svgLayer = $('map-connections');
        const container = $('map-preview');

        canvas.innerHTML = '';
        svgLayer.innerHTML = '';

        const communities = loadedData.communities || [];
        const connections = loadedData.connections || [];

        // Get container dimensions
        const rect = container.getBoundingClientRect();
        const width = rect.width;
        const height = rect.height;

        // Build lookup for community positions
        const posLookup = {};
        communities.forEach(c => {
          if (c.x !== undefined && c.y !== undefined) {
            // x, y are stored as pixel values relative to original canvas
            // Convert to percentage then to current container size
            posLookup[c.id] = {
              x: (c.x / 800) * width,  // assuming original canvas was 800px
              y: (c.y / 800) * height
            };
          }
        });

        // Render connections first (behind cards)
        connections.forEach(conn => {
          const fromPos = posLookup[conn.from];
          const toPos = posLookup[conn.to];
          if (!fromPos || !toPos) return;

          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          path.setAttribute('d', getConnectionPath(fromPos.x, fromPos.y, toPos.x, toPos.y, conn.type));
          path.setAttribute('class', `conn-${conn.type}`);
          svgLayer.appendChild(path);
        });

        // Render community cards
        communities.forEach(c => {
          if (c.x === undefined || c.y === undefined) return;

          const pos = posLookup[c.id];
          if (!pos) return;

          const sizeClass = c.importance || 'medium';
          const card = document.createElement('div');
          card.className = `map-group-card size-${sizeClass}`;
          card.style.left = pos.x + 'px';
          card.style.top = pos.y + 'px';
          card.innerHTML = `<span class="card-name">${escapeHtml(c.name)}</span>`;
          canvas.appendChild(card);
        });
      }

      function getConnectionPath(x1, y1, x2, y2, type) {
        if (type === 'easy') {
          return `M${x1},${y1} L${x2},${y2}`;
        } else if (type === 'moderate') {
          // Wavy line
          const dx = x2 - x1;
          const dy = y2 - y1;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const waves = Math.max(2, Math.floor(dist / 40));
          const perpX = -dy / dist * 10;
          const perpY = dx / dist * 10;

          let d = `M${x1},${y1}`;
          for (let i = 1; i <= waves; i++) {
            const t = i / waves;
            const mx = x1 + dx * t;
            const my = y1 + dy * t;
            const sign = i % 2 === 1 ? 1 : -1;
            const cx = x1 + dx * (t - 0.5 / waves) + perpX * sign;
            const cy = y1 + dy * (t - 0.5 / waves) + perpY * sign;
            d += ` Q${cx},${cy} ${mx},${my}`;
          }
          return d;
        } else {
          // Jagged line
          const dx = x2 - x1;
          const dy = y2 - y1;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const segments = Math.max(3, Math.floor(dist / 25));
          const perpX = -dy / dist * 8;
          const perpY = dx / dist * 8;

          let d = `M${x1},${y1}`;
          for (let i = 1; i <= segments; i++) {
            const t = i / segments;
            const px = x1 + dx * t;
            const py = y1 + dy * t;
            if (i < segments) {
              const sign = i % 2 === 1 ? 1 : -1;
              d += ` L${px + perpX * sign},${py + perpY * sign}`;
            } else {
              d += ` L${px},${py}`;
            }
          }
          return d;
        }
      }

      function renderConnectionsTable() {
        const tbody = $('connections-table');
        const connections = loadedData.connections || [];
        const communities = loadedData.communities || [];

        // Build lookup
        const nameLookup = {};
        communities.forEach(c => { nameLookup[c.id] = c.name; });

        if (connections.length === 0) {
          $('connections-table-container').classList.add('hidden');
          $('no-connections').classList.remove('hidden');
          return;
        }

        $('connections-table-container').classList.remove('hidden');
        $('no-connections').classList.add('hidden');

        tbody.innerHTML = connections.map(conn => {
          const fromName = nameLookup[conn.from] || conn.from;
          const toName = nameLookup[conn.to] || conn.to;
          const typeLabel = CONNECTION_LABELS[conn.type] || conn.type;
          const typeSvg = getConnectionTypeSvg(conn.type);

          return `
            <tr>
              <td>${escapeHtml(fromName)}</td>
              <td>${escapeHtml(toName)}</td>
              <td><span class="conn-type">${typeSvg} ${typeLabel}</span></td>
            </tr>
          `;
        }).join('');
      }

      function getConnectionTypeSvg(type) {
        if (type === 'easy') {
          return '<svg width="40" height="12"><line x1="0" y1="6" x2="40" y2="6" stroke="#495057" stroke-width="3"/></svg>';
        } else if (type === 'moderate') {
          return '<svg width="40" height="12"><path d="M0,6 Q10,0 20,6 Q30,12 40,6" stroke="#495057" stroke-width="3" fill="none"/></svg>';
        } else {
          return '<svg width="40" height="12"><path d="M0,6 L8,1 L16,11 L24,1 L32,11 L40,6" stroke="#495057" stroke-width="3" fill="none"/></svg>';
        }
      }

      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

    })();
  </script>
</body>
</html>
