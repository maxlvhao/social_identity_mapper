<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Researcher View - Social Identity Mapping</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Researcher-specific styles */
    .researcher-page {
      min-height: 100vh;
      padding: 30px;
      max-width: 1000px;
      margin: 0 auto;
    }

    .researcher-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .researcher-header h1 {
      font-size: 1.75rem;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .researcher-header p {
      color: var(--text-light);
    }

    .upload-section {
      text-align: center;
      margin-bottom: 20px;
    }

    .upload-area {
      background: var(--card-bg);
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 40px;
      max-width: 500px;
      margin: 0 auto;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-area:hover, .upload-area.dragover {
      border-color: var(--primary);
      background: #f8f9ff;
    }

    .upload-area p {
      margin-bottom: 15px;
      color: var(--text-light);
    }

    .upload-area input[type="file"] {
      display: none;
    }

    .load-divider {
      display: flex;
      align-items: center;
      gap: 15px;
      max-width: 500px;
      margin: 20px auto;
      color: var(--text-light);
      font-size: 13px;
    }

    .load-divider::before,
    .load-divider::after {
      content: '';
      flex: 1;
      border-top: 1px solid var(--border);
    }

    .session-lookup {
      max-width: 500px;
      margin: 0 auto;
      display: flex;
      gap: 10px;
    }

    .session-lookup input {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    .session-lookup input:focus {
      border-color: var(--primary);
    }

    .session-lookup button {
      white-space: nowrap;
    }

    .loading-msg {
      text-align: center;
      color: var(--text-light);
      padding: 15px;
      font-style: italic;
    }

    .error-msg {
      text-align: center;
      color: #e74c3c;
      padding: 10px;
      font-size: 14px;
    }

    .report-section {
      display: none;
    }

    .report-section.active {
      display: block;
    }

    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .session-info-bar {
      background: var(--card-bg);
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    .session-info-bar span {
      margin-right: 20px;
      font-size: 14px;
    }

    .session-info-bar strong {
      color: var(--primary);
    }

    .back-link {
      position: fixed;
      top: 15px;
      left: 15px;
      color: var(--text-light);
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      z-index: 100;
    }

    .back-link:hover {
      color: var(--primary);
    }

    /* Report Cards */
    .report-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    .report-card h3 {
      color: var(--primary);
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--primary);
      font-size: 1.1rem;
    }

    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .data-table th,
    .data-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .data-table th {
      background: var(--bg);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      color: var(--text-light);
    }

    .data-table tbody tr:hover {
      background: #f8f9fa;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-high {
      background: var(--importance-high);
      color: white;
    }

    .badge-medium {
      background: var(--importance-medium);
      color: white;
    }

    .badge-low {
      background: var(--importance-low);
      color: white;
    }

    /* Map Preview - square like main app */
    .map-preview {
      width: 100%;
      max-width: 600px;
      aspect-ratio: 1 / 1;
      margin: 0 auto;
      background: white;
      border: 2px solid var(--border);
      border-radius: 12px;
      position: relative;
      overflow: hidden;
      background-image:
        linear-gradient(var(--border) 1px, transparent 1px),
        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 40px 40px;
    }

    .map-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    /* SVG connections layer */
    .map-connections {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    /* Group cards on map — use original sizes, CSS scale handles fitting */
    .map-group-card {
      position: absolute;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      user-select: none;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.15);
    }

    .map-group-card.size-high {
      width: 130px;
      height: 130px;
      background: var(--importance-high);
    }

    .map-group-card.size-medium {
      width: 100px;
      height: 100px;
      background: var(--importance-medium);
    }

    .map-group-card.size-low {
      width: 75px;
      height: 75px;
      background: var(--importance-low);
    }

    .map-group-card .card-name {
      color: white;
      font-weight: 600;
      text-align: center;
      padding: 5px;
      font-size: 13px;
      word-break: break-word;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
      line-height: 1.2;
    }

    .map-group-card.size-low .card-name {
      font-size: 11px;
    }

    /* Topics attached to map cards */
    .map-card-topics {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
      padding-top: 3px;
      justify-content: center;
      max-width: 120px;
    }

    .map-card-topic-tag {
      display: inline-flex;
      align-items: center;
      gap: 2px;
      padding: 1px 5px;
      background: white;
      border: 1px solid var(--primary);
      border-radius: 8px;
      font-size: 8px;
      white-space: nowrap;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .map-card-topic-tag .topic-icon {
      font-size: 8px;
    }

    /* Connection lines */
    .conn-easy {
      stroke: var(--conn-color);
      stroke-width: 3;
      fill: none;
    }

    .conn-moderate {
      stroke: var(--conn-color);
      stroke-width: 3;
      fill: none;
    }

    .conn-difficult {
      stroke: var(--conn-color);
      stroke-width: 3;
      fill: none;
    }

    /* Connections table */
    .conn-type {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .conn-type svg {
      flex-shrink: 0;
    }

    /* Legend */
    .legend {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border);
      justify-content: center;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .legend-box {
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }

    .legend-box.high { background: var(--importance-high); }
    .legend-box.medium { background: var(--importance-medium); }
    .legend-box.low { background: var(--importance-low); }

    /* Empty state */
    .empty-state {
      text-align: center;
      color: var(--text-light);
      padding: 20px;
      font-style: italic;
    }

    /* ==================== Survey Data Styles ==================== */

    /* Demographics grid */
    .demographics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
    }

    .demo-item {
      display: flex;
      flex-direction: column;
      gap: 3px;
      padding: 10px 14px;
      background: var(--bg);
      border-radius: 8px;
    }

    .demo-label {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-light);
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .demo-value {
      font-size: 15px;
      color: var(--text);
      font-weight: 500;
    }

    /* Scale charts */
    .scale-chart {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .scale-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .scale-label {
      width: 280px;
      min-width: 280px;
      font-size: 13px;
      line-height: 1.3;
      color: var(--text);
      text-align: right;
    }

    .scale-bar-track {
      flex: 1;
      height: 22px;
      background: #eef0f4;
      border-radius: 4px;
      overflow: hidden;
    }

    .scale-bar-fill {
      height: 100%;
      border-radius: 4px;
      min-width: 2px;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .scale-bar-fill.nfm {
      background: linear-gradient(90deg, #7986CB, #3F51B5);
    }

    .scale-bar-fill.auth {
      background: linear-gradient(90deg, #81C784, #43A047);
    }

    .scale-value {
      width: 36px;
      text-align: right;
      font-weight: 600;
      font-size: 14px;
      color: var(--text);
      flex-shrink: 0;
    }

    .scale-max-label {
      font-size: 11px;
      color: var(--text-light);
      text-align: right;
      margin-top: 4px;
    }

    @media (max-width: 768px) {
      .scale-label {
        width: 160px;
        min-width: 160px;
        font-size: 12px;
      }

      .demographics-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }
    }
  </style>
</head>
<body>
  <div class="researcher-page">
    <a href="/" class="back-link">&larr; Back to Activity</a>

    <div class="researcher-header">
      <h1>Researcher View</h1>
      <p>Look up a session by ID, pick from recent sessions, or upload a JSON file to view a participant's report.</p>
    </div>

    <div class="upload-section" id="upload-section">
      <div class="session-lookup">
        <input type="text" id="session-id-input" placeholder="Enter session ID..." />
        <button class="btn btn-primary" id="load-session-btn">Load Session</button>
      </div>
      <div id="error-container"></div>

      <div class="load-divider">or upload a file</div>

      <div class="upload-area" id="upload-area">
        <p>Drag and drop a JSON file here, or click to select</p>
        <button class="btn btn-primary">Choose File</button>
        <input type="file" id="file-input" accept=".json">
      </div>
    </div>

    <div class="report-section" id="report-section">
      <div class="report-header">
        <div class="session-info-bar">
          <span>Session: <strong id="report-session">--</strong></span>
          <span>Created: <strong id="report-date">--</strong></span>
        </div>
        <button class="btn btn-secondary" id="load-another">Load Another File</button>
      </div>

      <!-- Survey Data (shown only when a matching survey_responses row exists) -->
      <div id="survey-section" class="hidden">
        <!-- Demographics -->
        <div class="report-card" id="demographics-card">
          <h3>Demographics</h3>
          <div class="demographics-grid" id="demographics-grid"></div>
        </div>

        <!-- News Finds Me Scale -->
        <div class="report-card" id="nfm-card">
          <h3>News Finds Me</h3>
          <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">
            Agreement scale (1–10). Higher scores indicate stronger agreement.
          </p>
          <div class="scale-chart" id="nfm-chart"></div>
          <div class="scale-max-label">Scale: 1–10</div>
        </div>

        <!-- Authenticity Scale -->
        <div class="report-card" id="auth-card">
          <h3>Authenticity Scale</h3>
          <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">
            Self-description scale (1–7). Higher scores indicate stronger agreement.
          </p>
          <div class="scale-chart" id="auth-chart"></div>
          <div class="scale-max-label">Scale: 1–7</div>
        </div>
      </div>

      <!-- Communities Section -->
      <div class="report-card">
        <h3>Communities</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Community</th>
              <th>Importance</th>
              <th>Positivity</th>
              <th>Contact (days)</th>
              <th>Tenure (years)</th>
              <th>Representativeness</th>
            </tr>
          </thead>
          <tbody id="communities-table"></tbody>
        </table>
      </div>

      <!-- Position Map Section -->
      <div class="report-card">
        <h3>Position Map</h3>
        <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">
          Communities positioned by information overlap. Closer groups share more similar information. Topics are shown attached to their assigned communities.
        </p>
        <div class="map-preview" id="map-preview">
          <svg class="map-connections" id="map-connections"></svg>
          <div class="map-canvas" id="map-canvas"></div>
        </div>
        <div class="legend">
          <div class="legend-item"><span class="legend-box high"></span> Very Important</div>
          <div class="legend-item"><span class="legend-box medium"></span> Moderate</div>
          <div class="legend-item"><span class="legend-box low"></span> Less Important</div>
        </div>
      </div>

      <!-- Connections Section -->
      <div class="report-card">
        <h3>Connections</h3>
        <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">
          How easy it would be to discuss the same news topic across groups.
        </p>
        <table class="data-table" id="connections-table-container">
          <thead>
            <tr>
              <th>From</th>
              <th>To</th>
              <th>Conversation Flow</th>
            </tr>
          </thead>
          <tbody id="connections-table"></tbody>
        </table>
        <div class="empty-state hidden" id="no-connections">No connections drawn.</div>
      </div>

      <!-- Topics Section -->
      <div class="report-card">
        <h3>Topic Placements</h3>
        <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">
          News topics assigned to communities.
        </p>
        <table class="data-table" id="topics-table-container">
          <thead>
            <tr>
              <th>Topic</th>
              <th>Community</th>
              <th>Count</th>
            </tr>
          </thead>
          <tbody id="topics-table"></tbody>
        </table>
        <div class="empty-state hidden" id="no-topics">No topics placed.</div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      'use strict';

      const $ = id => document.getElementById(id);
      let loadedData = null;

      const IMPORTANCE_LABELS = {
        'high': 'Very Important',
        'medium': 'Moderate',
        'low': 'Less Important'
      };

      const CONNECTION_LABELS = {
        'easy': 'Easy',
        'moderate': 'Moderate',
        'difficult': 'Difficult'
      };

      // ==================== Survey Label Maps ====================

      const DEMO_LABELS = {
        age: 'Age',
        gender: 'Gender',
        genderOther: 'Gender (Other)',
        race: 'Race / Ethnicity',
        raceOther: 'Race (Other)',
        year: 'Year',
        yearOther: 'Year (Other)',
        isStudent: 'Student Status',
        isFirstGen: 'First Generation',
        isTransfer: 'Transfer Student',
        isInternational: 'International Student',
        sexAtBirth: 'Sex at Birth',
        sexOther: 'Sex (Other)',
        sexualOrientation: 'Sexual Orientation',
        sexualOrientationOther: 'Sexual Orientation (Other)'
      };

      // News Finds Me — Gil de Zúñiga, Weeks & Ardèvol-Abreu (2017)
      const NFM_LABELS = {
        wellInformedPassively: 'I can be well informed even when I don\'t actively follow the news',
        newsWillFindMe: 'News will find me even when I don\'t look for it',
        relyOnFriends: 'I rely on my friends/peers to tell me what\'s important',
        relyOnFriendsSocialMedia: 'I rely on friends/social media to keep me informed'
      };

      // Authenticity Scale — Wood et al. (2008)
      // Subscales: Authentic Living (AL), Accepting External Influence (AEI), Self-Alienation (SA)
      const AUTH_LABELS = {
        // Authentic Living
        betterToBeYourself: 'I think it is better to be yourself than to be popular',
        standByBeliefs: 'I always stand by what I believe in',
        trueToMyself: 'I am true to myself in most situations',
        liveByValues: 'I live in accordance with my values and beliefs',
        // Accepting External Influence
        influencedByOpinions: 'I am strongly influenced by the opinions of others',
        doWhatOthersTell: 'I usually do what other people tell me to do',
        doWhatOthersExpect: 'I always feel I need to do what others expect me to do',
        othersInfluenceGreatly: 'Other people influence me greatly',
        // Self-Alienation
        dontKnowHowIFeel: 'I don\'t know how I really feel inside',
        dontKnowMyself: 'I feel as if I don\'t know myself very well',
        outOfTouchRealMe: 'I feel out of touch with the "real me"',
        alienatedFromSelf: 'I feel alienated from myself'
      };

      function humanizeKey(key) {
        return key
          .replace(/([A-Z])/g, ' $1')
          .replace(/[_-]/g, ' ')
          .replace(/\s+/g, ' ')
          .trim()
          .replace(/^\w/, c => c.toUpperCase());
      }

      const NEWS_TOPICS = {
        'international': { icon: '\u{1F30D}', short: 'International', full: 'International / World News' },
        'national': { icon: '\u{1F3DB}\uFE0F', short: 'National', full: 'National Politics' },
        'local': { icon: '\u{1F3D8}\uFE0F', short: 'Local', full: 'Local / Community News' },
        'campus': { icon: '\u{1F393}', short: 'Campus', full: 'Campus / Education' },
        'business': { icon: '\u{1F4BC}', short: 'Business', full: 'Business & Economy' },
        'science': { icon: '\u{1F52C}', short: 'Science', full: 'Science & Technology' },
        'entertainment': { icon: '\u{1F3AC}', short: 'Entertainment', full: 'Entertainment' },
        'sports': { icon: '\u26BD', short: 'Sports', full: 'Sports' },
        'health': { icon: '\u{1F3E5}', short: 'Health', full: 'Health & Lifestyle' },
        'professional': { icon: '\u{1F4CA}', short: 'Professional', full: 'Professional / Industry' }
      };

      // File upload handling
      const uploadArea = $('upload-area');
      const fileInput = $('file-input');

      uploadArea.addEventListener('click', () => fileInput.click());

      uploadArea.addEventListener('dragover', e => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) loadFile(file);
      });

      fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) loadFile(file);
      });

      $('load-another').addEventListener('click', () => {
        $('upload-section').style.display = 'block';
        $('report-section').classList.remove('active');
        $('survey-section').classList.add('hidden');
        fileInput.value = '';
      });

      // Session ID lookup
      const sessionInput = $('session-id-input');
      const loadBtn = $('load-session-btn');

      loadBtn.addEventListener('click', () => loadSessionById(sessionInput.value.trim()));
      sessionInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') loadSessionById(sessionInput.value.trim());
      });

      async function loadSessionById(id) {
        if (!id) return;
        const errorContainer = $('error-container');
        errorContainer.innerHTML = '';

        try {
          const res = await fetch(`/api/session/${encodeURIComponent(id)}`);
          if (!res.ok) {
            errorContainer.innerHTML = '<div class="error-msg">Session not found. Check the ID and try again.</div>';
            return;
          }
          loadedData = await res.json();
          migratePlacedTopics();
          renderReport();
        } catch (err) {
          errorContainer.innerHTML = '<div class="error-msg">Failed to load session. Please try again.</div>';
        }
      }

      // Migrate old {x, y} format to {communityId}
      function migratePlacedTopics() {
        if (!loadedData || !loadedData.placedTopics || loadedData.placedTopics.length === 0) return;

        const needsMigration = loadedData.placedTopics.some(p => p.x !== undefined && p.communityId === undefined);
        if (!needsMigration) return;

        const communities = loadedData.communities || [];

        loadedData.placedTopics = loadedData.placedTopics.map(placed => {
          if (placed.communityId !== undefined) return placed;
          if (placed.x === undefined || placed.y === undefined) return placed;

          let nearestId = null;
          let nearestDist = Infinity;

          communities.forEach(c => {
            if (c.x === null || c.y === null || c.x === undefined || c.y === undefined) return;
            const size = c.importance === 'high' ? 130 : c.importance === 'low' ? 75 : 100;
            const cx = c.x + size / 2;
            const cy = c.y + size / 2;
            const dx = placed.x - cx;
            const dy = placed.y - cy;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < nearestDist) {
              nearestDist = dist;
              nearestId = c.id;
            }
          });

          return {
            id: placed.id,
            topicId: placed.topicId,
            communityId: nearestId
          };
        }).filter(p => p.communityId !== null);
      }

      // Check if URL has a session ID parameter
      const urlParams = new URLSearchParams(window.location.search);
      const urlSessionId = urlParams.get('session');
      if (urlSessionId) {
        sessionInput.value = urlSessionId;
        loadSessionById(urlSessionId);
      }

      function loadFile(file) {
        const reader = new FileReader();
        reader.onload = e => {
          try {
            loadedData = JSON.parse(e.target.result);
            migratePlacedTopics();
            renderReport();
          } catch (err) {
            alert('Invalid JSON file');
          }
        };
        reader.readAsText(file);
      }

      // ==================== Survey Data ====================

      async function loadSurveyData(sessionId) {
        try {
          const res = await fetch(`/api/session/${encodeURIComponent(sessionId)}/survey`);
          if (!res.ok) return null;
          return await res.json();
        } catch {
          return null;
        }
      }

      function renderSurveyData(surveyData) {
        const section = $('survey-section');

        if (!surveyData) {
          section.classList.add('hidden');
          return;
        }

        section.classList.remove('hidden');

        // Demographics
        if (surveyData.demographics && Object.keys(surveyData.demographics).length > 0) {
          $('demographics-card').classList.remove('hidden');
          renderDemographics(surveyData.demographics);
        } else {
          $('demographics-card').classList.add('hidden');
        }

        // News Finds Me
        if (surveyData.newsFindsMe && Object.keys(surveyData.newsFindsMe).length > 0) {
          $('nfm-card').classList.remove('hidden');
          renderScaleChart('nfm-chart', surveyData.newsFindsMe, 10, NFM_LABELS, 'nfm');
        } else {
          $('nfm-card').classList.add('hidden');
        }

        // Authenticity Scale
        if (surveyData.authenticityScale && Object.keys(surveyData.authenticityScale).length > 0) {
          $('auth-card').classList.remove('hidden');
          renderScaleChart('auth-chart', surveyData.authenticityScale, 7, AUTH_LABELS, 'auth');
        } else {
          $('auth-card').classList.add('hidden');
        }
      }

      function renderDemographics(demo) {
        const grid = $('demographics-grid');
        // Filter out empty/null values so we only show fields that have data
        const entries = Object.entries(demo).filter(([key, value]) =>
          value !== null && value !== undefined && value !== ''
        );
        if (entries.length === 0) {
          $('demographics-card').classList.add('hidden');
          return;
        }
        grid.innerHTML = entries.map(([key, value]) => {
          const label = DEMO_LABELS[key] || humanizeKey(key);
          return `
            <div class="demo-item">
              <span class="demo-label">${escapeHtml(label)}</span>
              <span class="demo-value">${escapeHtml(String(value))}</span>
            </div>
          `;
        }).join('');
      }

      function renderScaleChart(containerId, items, maxValue, labelMap, colorClass) {
        const container = $(containerId);
        // Filter out empty/null values
        const entries = Object.entries(items).filter(([key, value]) =>
          value !== null && value !== undefined && value !== ''
        );

        if (entries.length === 0) {
          container.closest('.report-card').classList.add('hidden');
          return;
        }

        container.innerHTML = entries.map(([key, value]) => {
          const label = labelMap[key] || humanizeKey(key);
          const numValue = parseFloat(value) || 0;
          const pct = Math.min((numValue / maxValue) * 100, 100);
          return `
            <div class="scale-row">
              <div class="scale-label">${escapeHtml(label)}</div>
              <div class="scale-bar-track">
                <div class="scale-bar-fill ${colorClass}" style="width: 0%"
                     data-target-width="${pct}%"></div>
              </div>
              <div class="scale-value">${numValue}</div>
            </div>
          `;
        }).join('');

        // Animate bars in after a brief delay
        requestAnimationFrame(() => {
          container.querySelectorAll('.scale-bar-fill').forEach(bar => {
            bar.style.width = bar.dataset.targetWidth;
          });
        });
      }

      // ==================== Report Rendering ====================

      async function renderReport() {
        if (!loadedData) return;

        $('upload-section').style.display = 'none';
        $('report-section').classList.add('active');

        // Header info
        $('report-session').textContent = loadedData.sessionId || 'Unknown';
        $('report-date').textContent = loadedData.createdAt ? new Date(loadedData.createdAt).toLocaleDateString() : '--';

        // Survey data (fetched async, shown above activity data if available)
        const sessionId = loadedData.sessionId;
        if (sessionId) {
          loadSurveyData(sessionId).then(renderSurveyData);
        } else {
          $('survey-section').classList.add('hidden');
        }

        // Communities table
        renderCommunitiesTable();

        // Position map with connections and topics
        renderMap();

        // Connections table
        renderConnectionsTable();

        // Topics table
        renderTopicsTable();
      }

      function renderCommunitiesTable() {
        const tbody = $('communities-table');
        const communities = loadedData.communities || [];

        if (communities.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No communities added.</td></tr>';
          return;
        }

        tbody.innerHTML = communities.map(c => {
          const importanceClass = c.importance || 'medium';
          return `
            <tr>
              <td><strong>${escapeHtml(c.name)}</strong></td>
              <td><span class="badge badge-${importanceClass}">${IMPORTANCE_LABELS[c.importance] || '--'}</span></td>
              <td>${c.positivity !== undefined ? c.positivity + '/10' : '--'}</td>
              <td>${c.contact !== undefined ? c.contact : '--'}</td>
              <td>${c.tenure !== undefined ? c.tenure : '--'}</td>
              <td>${c.representativeness !== undefined ? c.representativeness + '/10' : '--'}</td>
            </tr>
          `;
        }).join('');
      }

      function renderMap() {
        const canvas = $('map-canvas');
        const svgLayer = $('map-connections');
        const container = $('map-preview');

        canvas.innerHTML = '';
        svgLayer.innerHTML = '';

        const communities = loadedData.communities || [];
        const connections = loadedData.connections || [];
        const placedTopics = loadedData.placedTopics || [];

        if (communities.length === 0) return;

        const containerWidth = container.clientWidth;
        const containerHeight = container.clientHeight;

        // Card sizes matching the main app
        function cardSize(importance) {
          return importance === 'high' ? 130 : importance === 'low' ? 75 : 100;
        }

        // 1. Calculate bounding box of all content in original coordinates
        let minX = Infinity, minY = Infinity;
        let maxX = -Infinity, maxY = -Infinity;

        communities.forEach(c => {
          if (c.x == null || c.y == null) return;
          const s = cardSize(c.importance);
          if (c.x < minX) minX = c.x;
          if (c.y < minY) minY = c.y;
          if (c.x + s > maxX) maxX = c.x + s;
          if (c.y + s > maxY) maxY = c.y + s;

          // Account for topics extending below and sideways
          const topicCount = placedTopics.filter(p => p.communityId === c.id).length;
          if (topicCount > 0) {
            const topicHeight = Math.ceil(topicCount / 2) * 24 + 8;
            if (c.y + s + topicHeight > maxY) maxY = c.y + s + topicHeight;
            const center = c.x + s / 2;
            const half = 65; // half of map-card-topics max-width (120) + margin
            if (center - half < minX) minX = center - half;
            if (center + half > maxX) maxX = center + half;
          }
        });

        if (minX === Infinity) return;

        // 2. Add padding, compute content size and scale
        const pad = 20;
        const contentWidth = maxX - minX + pad * 2;
        const contentHeight = maxY - minY + pad * 2;
        const scale = Math.min(containerWidth / contentWidth, containerHeight / contentHeight, 1);

        // 3. Center the scaled content in the container
        const offsetX = (containerWidth - contentWidth * scale) / 2;
        const offsetY = (containerHeight - contentHeight * scale) / 2;

        // Apply to both layers
        [canvas, svgLayer].forEach(el => {
          el.style.width = contentWidth + 'px';
          el.style.height = contentHeight + 'px';
          el.style.transform = `scale(${scale})`;
          el.style.transformOrigin = 'top left';
          el.style.left = offsetX + 'px';
          el.style.top = offsetY + 'px';
        });

        // 4. Build offset positions (shift so content starts at padding)
        const posLookup = {};
        communities.forEach(c => {
          if (c.x == null || c.y == null) return;
          const s = cardSize(c.importance);
          posLookup[c.id] = {
            x: c.x - minX + pad,
            y: c.y - minY + pad,
            cx: c.x - minX + pad + s / 2,
            cy: c.y - minY + pad + s / 2
          };
        });

        // 5. Render connections (using center points)
        connections.forEach(conn => {
          const fromPos = posLookup[conn.from];
          const toPos = posLookup[conn.to];
          if (!fromPos || !toPos) return;

          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          path.setAttribute('d', getConnectionPath(fromPos.cx, fromPos.cy, toPos.cx, toPos.cy, conn.type));
          path.setAttribute('class', `conn-${conn.type}`);
          svgLayer.appendChild(path);
        });

        // 6. Build topic lookup
        const topicsByCommunity = {};
        placedTopics.forEach(p => {
          if (!topicsByCommunity[p.communityId]) topicsByCommunity[p.communityId] = [];
          topicsByCommunity[p.communityId].push(p);
        });

        // 7. Render cards at top-left positions
        communities.forEach(c => {
          const pos = posLookup[c.id];
          if (!pos) return;

          const sizeClass = c.importance || 'medium';
          const card = document.createElement('div');
          card.className = `map-group-card size-${sizeClass}`;
          card.style.left = pos.x + 'px';
          card.style.top = pos.y + 'px';

          let cardHTML = `<span class="card-name">${escapeHtml(c.name)}</span>`;

          const cardTopics = topicsByCommunity[c.id] || [];
          if (cardTopics.length > 0) {
            cardHTML += '<div class="map-card-topics">';
            cardTopics.forEach(placed => {
              const topic = NEWS_TOPICS[placed.topicId];
              if (!topic) return;
              cardHTML += `<span class="map-card-topic-tag"><span class="topic-icon">${topic.icon}</span>${topic.short}</span>`;
            });
            cardHTML += '</div>';
          }

          card.innerHTML = cardHTML;
          canvas.appendChild(card);
        });
      }

      function getConnectionPath(x1, y1, x2, y2, type) {
        if (type === 'easy') {
          return `M${x1},${y1} L${x2},${y2}`;
        } else if (type === 'moderate') {
          // Wavy line
          const dx = x2 - x1;
          const dy = y2 - y1;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const waves = Math.max(2, Math.floor(dist / 40));
          const perpX = -dy / dist * 10;
          const perpY = dx / dist * 10;

          let d = `M${x1},${y1}`;
          for (let i = 1; i <= waves; i++) {
            const t = i / waves;
            const mx = x1 + dx * t;
            const my = y1 + dy * t;
            const sign = i % 2 === 1 ? 1 : -1;
            const cx = x1 + dx * (t - 0.5 / waves) + perpX * sign;
            const cy = y1 + dy * (t - 0.5 / waves) + perpY * sign;
            d += ` Q${cx},${cy} ${mx},${my}`;
          }
          return d;
        } else {
          // Jagged line
          const dx = x2 - x1;
          const dy = y2 - y1;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const segments = Math.max(3, Math.floor(dist / 25));
          const perpX = -dy / dist * 8;
          const perpY = dx / dist * 8;

          let d = `M${x1},${y1}`;
          for (let i = 1; i <= segments; i++) {
            const t = i / segments;
            const px = x1 + dx * t;
            const py = y1 + dy * t;
            if (i < segments) {
              const sign = i % 2 === 1 ? 1 : -1;
              d += ` L${px + perpX * sign},${py + perpY * sign}`;
            } else {
              d += ` L${px},${py}`;
            }
          }
          return d;
        }
      }

      function renderConnectionsTable() {
        const tbody = $('connections-table');
        const connections = loadedData.connections || [];
        const communities = loadedData.communities || [];

        // Build lookup
        const nameLookup = {};
        communities.forEach(c => { nameLookup[c.id] = c.name; });

        if (connections.length === 0) {
          $('connections-table-container').classList.add('hidden');
          $('no-connections').classList.remove('hidden');
          return;
        }

        $('connections-table-container').classList.remove('hidden');
        $('no-connections').classList.add('hidden');

        tbody.innerHTML = connections.map(conn => {
          const fromName = nameLookup[conn.from] || conn.from;
          const toName = nameLookup[conn.to] || conn.to;
          const typeLabel = CONNECTION_LABELS[conn.type] || conn.type;
          const typeSvg = getConnectionTypeSvg(conn.type);

          return `
            <tr>
              <td>${escapeHtml(fromName)}</td>
              <td>${escapeHtml(toName)}</td>
              <td><span class="conn-type">${typeSvg} ${typeLabel}</span></td>
            </tr>
          `;
        }).join('');
      }

      function getConnectionTypeSvg(type) {
        if (type === 'easy') {
          return '<svg width="40" height="12"><line x1="0" y1="6" x2="40" y2="6" stroke="#495057" stroke-width="3"/></svg>';
        } else if (type === 'moderate') {
          return '<svg width="40" height="12"><path d="M0,6 Q10,0 20,6 Q30,12 40,6" stroke="#495057" stroke-width="3" fill="none"/></svg>';
        } else {
          return '<svg width="40" height="12"><path d="M0,6 L8,1 L16,11 L24,1 L32,11 L40,6" stroke="#495057" stroke-width="3" fill="none"/></svg>';
        }
      }

      function renderTopicsTable() {
        const tbody = $('topics-table');
        const placedTopics = loadedData.placedTopics || [];
        const communities = loadedData.communities || [];

        if (placedTopics.length === 0) {
          $('topics-table-container').classList.add('hidden');
          $('no-topics').classList.remove('hidden');
          return;
        }

        $('topics-table-container').classList.remove('hidden');
        $('no-topics').classList.add('hidden');

        // Build community name lookup
        const nameLookup = {};
        communities.forEach(c => { nameLookup[c.id] = c.name; });

        // Group by topicId + communityId
        const grouped = {};
        placedTopics.forEach(p => {
          const key = `${p.topicId}__${p.communityId}`;
          if (!grouped[key]) {
            grouped[key] = { topicId: p.topicId, communityId: p.communityId, count: 0 };
          }
          grouped[key].count++;
        });

        tbody.innerHTML = Object.values(grouped).map(entry => {
          const topic = NEWS_TOPICS[entry.topicId] || { icon: '?', full: entry.topicId };
          const communityName = nameLookup[entry.communityId] || entry.communityId || '--';
          return `
            <tr>
              <td><span style="margin-right: 8px;">${topic.icon}</span> ${topic.full}</td>
              <td>${escapeHtml(communityName)}</td>
              <td>${entry.count}</td>
            </tr>
          `;
        }).join('');
      }

      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

    })();
  </script>
</body>
</html>
